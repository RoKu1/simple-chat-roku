name: Rust CI

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Cache Cargo Registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Check Formatting
        run: cargo fmt --all -- --check

      - name: Lint with Clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

      - name: Run Unit & Integration Tests
        run: cargo test --workspace

  smoke-test:
    name: End-to-End Smoke Test
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - uses: actions/checkout@v3
      - name: Build Release Binaries
        run: cargo build --release --workspace

      - name: Run Smoke Test Script
        run: |
          # 1. Start Server in background
          ./target/release/chat-server &
          SERVER_PID=$!
          echo "Server started (PID: $SERVER_PID)"
          sleep 3 # Wait for startup

          # 2. Start Client A (Roku1) in the background
          # She stays online longer (sleep 5) to hear Roku2
          (sleep 1; echo "send Hello I am waiting"; sleep 5; echo "leave") | ./target/release/chat-client 127.0.0.1 8080 Roku1 > roku1_output.txt &
          ROKU1_PID=$!

          # 3. Start Client B (Roku2)
          # Roku2 joins AFTER Roku1, sends a message, then leaves
          sleep 2
          (echo "send Hello Roku1 from Roku2"; sleep 1; echo "leave") | ./target/release/chat-client 127.0.0.1 8080 Roku2 > roku2_output.txt &
          ROKU2_PID=$!

          # Wait for both clients to finish their scripts
          wait $ROKU1_PID
          wait $ROKU2_PID
          
          # 4. Analyze Output
          echo "--- Roku1's Logs ---"
          cat roku1_output.txt
          echo "--- Roku2's Logs ---"
          cat roku2_output.txt
          
          # Check 1: Did Roku2 connect successfully?
          if grep -q "Welcome Roku2" roku2_output.txt; then
            echo "✅ Roku2 Handshake Success"
          else
            echo "❌ Roku2 Handshake Failed"
            kill $SERVER_PID
            exit 1
          fi

          # Check 2: Did Roku1 receive Roku2's message?
          if grep -q "Roku2: Hello Roku1 from Roku2" roku1_output.txt; then
            echo "✅ Broadcast Success (Roku1 heard Roku2)"
          else
            echo "❌ Broadcast Failed (Roku1 did not hear Roku2)"
            kill $SERVER_PID
            exit 1
          fi

          kill $SERVER_PID